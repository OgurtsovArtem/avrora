// ====================== LAZY-LOADING ======================
class Observer {
  constructor({
    element,
    activationRangeTop,
    activationRangeBottom,
    playOnce,
    updateFrequency,
    activeClass,
    top,
    bottom,
    imageLoad,
  }) {
    this.element = element;
    this.top = activationRangeTop ? top || 0 : null;
    this.bottom = activationRangeBottom ? bottom || 0 : null;
    this.activationRangeTop = activationRangeTop || false;
    this.activationRangeBottom = activationRangeBottom || false;
    this.playOnce = playOnce || false;
    this.updateFrequency = updateFrequency || 20;
    this.activeClass = activeClass || "_scroll";
    this.imageLoad = imageLoad;
    // Внутренние переменные
    this.entries = null;
    this.observer = null;
    this.observe();
  }

  _thresholdArray() {
    return Array(this.updateFrequency + 1)
      .fill(0)
      .map((item, index) => index / this.updateFrequency || 0);
  }

  _handleIntersect(entries) {
    [this.entries] = entries;
    this.scrollHandler();
    if (this.playOnce) {
      this.unobserve();
    }
  }

  observe() {
    this.observer = new IntersectionObserver(this._handleIntersect.bind(this), {
      threshold: this._thresholdArray(),
    });

    this.observer.observe(this.element);
  }

  unobserve() {
    const destroyWatcher = () => {
      this.observer.unobserve(this.element);
      this.element.removeEventListener("transitionend", destroyWatcher);
    };
    this.element.addEventListener("transitionend", destroyWatcher);
  }

  addClass() {
    this.element.classList.remove(this.activeClass);
  }

  removeClass() {
    this.element.classList.add(this.activeClass);
  }

  scrollHandler() {
    if (this.activationRangeTop || this.activationRangeBottom) {
      this.determiningDirection();
    } else {
      this.inObject();
    }
  }

  determiningDirection() {
    if (this.activationRangeTop) {
      this.atDistanceOnTop();
    } else if (this.activationRangeBottom) {
      this.atDistanceOnBottom();
    }
  }

  atDistanceOnTop() {
    return this.entries.boundingClientRect.top >= this.top
      ? this.addClass()
      : this.removeClass();
  }

  atDistanceOnBottom() {
    return this.entries.boundingClientRect.bottom <= this.bottom
      ? this.addClass()
      : this.removeClass();
  }
  setImageSrc() {
    const src = this.element.dataset.src;

    this.element.setAttribute("src", src);

    this.element.onload = () => {
      this.observer.unobserve(this.element);
      this.element.removeAttribute("data-src");
      this.element.dataset.lazy = "done";
    };

    this.element.onerror = () => {
      this.element.dataset.lazy = "error-loading";
    };
  }
  inObject() {
    if (this.entries.isIntersecting) {
      this.addClass();
      this.imageLoad ? this.setImageSrc() : null;
    } else {
      this.removeClass();
    }
  }
}
const lazyImages = [...document.querySelectorAll("img[data-lazy]")];
if (lazyImages) {
  lazyImages.forEach((image) => {
    const imageObserve = new Observer({
      element: image,
      imageLoad: true,
    });
  });
}
// ====================== POPUPS ======================
class Popups {
  constructor({ popup, openButtons, closeButtons, activeClass }) {
    this.popup = popup;
    this.openButtons = openButtons;
    this.closeButtons = closeButtons;
    this.activeClass = activeClass || "_active";
    if (!popup) {
      return;
    }
    this.init();
  }
  init() {
    this.closeButtons.forEach((button) => {
      button.addEventListener("click", this.close.bind(this));
    });
    this.openButtons.forEach((button) => {
      button.addEventListener("click", this.open.bind(this));
    });
  }

  open() {
    this.popup.classList.add(this.activeClass);
    document.body.style.overflow = "hidden";
  }
  close() {
    this.popup.classList.remove(this.activeClass);
    document.body.style.overflow = "initial";
  }
}

// ====================== FORM ======================
class Form {
  constructor(form, { errorClass, popupNext, popupCurrent }) {
    this.form = form;
    this.errorClass = errorClass;
    this.popupNext = popupNext;
    this.popupCurrent = popupCurrent;

    //константы
    this.submitButton = null;
    this.inputs = [];

    //Текст ошибок валидации
    this.words = {
      validationLenght: "Недостаточно символов",
      validationNull: "Это обязательное поле",
      validationEmail: "Неправильный формат Email",
      submitError: "Ошибка отправки формы",
    };

    //Инициализация
    if (this.form) {
      this.searchFormElements(); // Собираем данные формы
      this.inputObserve(); // ставим на них слушатели
      this.checkFormValidity(); // ставим слушатель на кнопку submit для проверки формы на пустоту
      this.submit(); // ставим event submit на форму для отправки
    }
  }
  // Поиск нужных полей формы
  searchFormElements() {
    [...this.form.elements].forEach((element) => {
      if (element.nodeName === "INPUT" || element.nodeName === "TEXTAREA") {
        this.inputs.push(element);
      }
      if (element.nodeName === "BUTTON" && element.type === "submit") {
        this.submitButton = element;
      }
    });
  }
  // Установка слушателя на каждый input
  inputObserve() {
    this.inputs.forEach((input) => {
      this.setListener(input);
    });
  }
  // Отчистка полей инпутов
  cleanInputs() {
    this.inputs.forEach((input) => {
      input.value = "";
    });
  }
  //Валидация формы при клике на кнопку submit
  checkFormValidity() {
    this.submitButton.addEventListener("click", () => {
      this.inputs.forEach((input) => {
        this.checkInputValidity(input);
      });
    });
  }

  //Обработка данных при вводе символа в текущее поле input
  formTarget(event) {
    const { target } = event;

    // Ставит маску для type='tel'
    if (target.type === "tel") {
      this.phoneMask(target);
    }
    // Валидирует поля
    this.checkInputValidity(target);

    // Анимация placeholder
    target.value.length > 0
      ? this.addFilledCalss(target)
      : this.removeFilledClass(target);
  }

  //Шаблон ошибки
  errorTemplate(error) {
    return ` <span class="${this.errorClass}">${error}</span>`;
  }

  //Добавляем шаблон после input'a
  inputError(input, error) {
    input.classList.add("_error");
    input.insertAdjacentHTML("afterend", this.errorTemplate(error).trim());
  }
  //Удаляем шаблон после input'a
  removeInputError(input) {
    input.classList.remove("_error");
    const nextElement = input.nextSibling;
    if (
      nextElement.nodeType == 1 &&
      nextElement.classList.contains(this.errorClass)
    ) {
      nextElement.remove();
    }
  }
  //Валидация инпута
  checkInputValidity(input) {
    const { validationLenght, validationNull, validationEmail } = this.words;

    this.removeInputError(input); // удалям предыдущие ошибки

    switch (true) {
      case input.validity.tooShort:
        this.inputError(input, validationLenght);
        break;
      case input.validity.valueMissing:
        this.inputError(input, validationNull);
        break;
      case input.validity.typeMismatch:
        this.inputError(input, validationEmail);
        break;
      default:
        this.removeInputError(input);
        break;
    }
  }
  // Прелоудер шаблон
  preloaderTemplate() {
    return `
      <div class="preloader">
        <div class="preloader__container"><span class="preloader__item preloader__item_1"></span><span class="preloader__item preloader__item_2"></span><span class="preloader__item preloader__item_3"></span><span class="preloader__item preloader__item_4"></span><span class="preloader__item preloader__item_5"></span><span class="preloader__item preloader__item_6"></span><span class="preloader__item preloader__item_7"></span><span class="preloader__item preloader__item_8"></span><span class="preloader__item preloader__item_9"></span><span class="preloader__item preloader__item_10"></span>
        </div>
      </div>
    `;
  }
  // активировать прелоудер  кнопки
  runPreloader() {
    this.submitButton.insertAdjacentHTML(
      "beforeend",
      this.preloaderTemplate().trim()
    );
  }
  // остановить прелоудер  кнопки
  stopPreloader() {
    this.submitButton.lastChild.remove();
  }
  // Обработка отправки
  submit() {
    let isSending = false; // флаг для избежания спама кликов
    this.form.addEventListener("submit", (event) => {
      event.preventDefault();
      // проверяем не закончился ли еще предыдущий запрос
      if (isSending) {
        return;
      }
      const formData = new FormData(this.form);
      isSending = true; // запрещаем последующие запросы пока не завершится текущий

      this.runPreloader(); // запускаем лоудер при отправке
      this.submitButton.dataset.errorName = ""; // обнуляем сообщение об ошибке

      this.sendForm(formData)
        .then(() => {
          this.form.dataset.state = "success"; // Статус формы
          this.popupCurrent ? this.popupCurrent.close() : null; // закрываем текущий попап при успешной отправке
          this.popupNext ? this.popupNext.open() : null; // открываем следующий попап(например с успешной отправкой формы)
        })
        .catch((error) => {
          this.form.dataset.state = "error"; // Статус формы
          this.submitButton.dataset.errorName = this.words.submitError; // выводим сообщение об ошибке под кнопкой
          console.error(error);
        })
        .finally(() => {
          this.stopPreloader(); // по завершению запроса останавливаем лоудер
          this.cleanInputs(); // и очищаем инпуты
          isSending = false; // разрешаем отправку запроса
        });
    });
  }
  // Отправка формы
  sendForm(data) {
    const body = JSON.stringify({
      name: this.form.name,
      data: JSON.stringify(data),
    });
    const url = "/";
    return fetch(url, {
      method: "POST",
      credentials: "include",
      mode: "no-cors",
      headers: {
        "Content-Type": "form/multipart",
      },
      body,
    }).then((response) => {
      if (!response.ok) {
        throw response;
      }
      return response;
    });
  }
  // Маска на поле телефона
  phoneMask(input) {
    let val = input.value.replace(/\D/g, "");

    if (val) {
      if (val[0] === "7" || val[0] === "8") {
        val = val.slice(1);
      }

      val = val.match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
      val =
        "+7" +
        (val[2] ? "(" + val[1] + ")" + val[2] : val[1] ? val[1] : "") +
        (val[3] ? "-" + val[3] : "") +
        (val[4] ? "-" + val[4] : "");
    }

    input.value = val;
  }
  // Добавление класса анимации placeholder'a
  addFilledCalss(element) {
    element.classList.add("_filled");
  }
  // Удаление класса анимации placeholder'a
  removeFilledClass(element) {
    element.classList.remove("_filled");
  }
  setListener(element) {
    element.addEventListener("input", this.formTarget.bind(this));
  }
}
const calcPopup = new Popups({
  popup: document.querySelector(".calc-popup"),
  closeButtons: document.querySelectorAll(".calc-popup__close"),
  openButtons: document.querySelectorAll("[data-popup-open='calc']"),
});
const callPopup = new Popups({
  popup: document.querySelector(".call-popup"),
  closeButtons: document.querySelectorAll(".call-popup__close"),
  openButtons: document.querySelectorAll("[data-popup-open='call']"),
});
const donePopup = new Popups({
  popup: document.querySelector(".done-popup"),
  closeButtons: document.querySelectorAll(".done-popup__button"),
  openButtons: document.querySelectorAll("[data-popup-open='done']"),
});

const application = document.forms.application;
const applicationFrom = new Form(application, {
  errorClass: "input__error",
  popupNext: donePopup,
});
const designer = document.forms.designer;
const designerFrom = new Form(designer, {
  errorClass: "input__error",
  popupNext: donePopup,
});
const calc = document.forms.calc;
const calcFrom = new Form(calc, {
  errorClass: "input__error",
  popupCurrent: calcPopup,
  popupNext: donePopup,
});
const call = document.forms.call;
const callFrom = new Form(call, {
  errorClass: "input__error",
  popupCurrent: callPopup,
  popupNext: donePopup,
});
// ====================== CIRCLE TEXT ======================

// расстояние между словами
const rotateBetweenWords = (value) => {
  const words = document.querySelectorAll(".circle-text__word");

  let deg = 0;

  for (let word of words) {
    word.style.transform = `rotate(${deg}deg)`;
    deg += value;
  }
};

// расстояние между буквами
const rotateBetweenLetters = (value) => {
  const letters = document.querySelectorAll(".circle-text__letter");

  let deg = 0;

  for (let letter of letters) {
    letter.style.transform = `rotate(${deg}deg)`;
    deg += value;
  }
};

rotateBetweenWords(0);
rotateBetweenLetters(10.5);
// ====================== SWIPER ======================

const kitchenSmallSwiper = new Swiper(".kitchen-large__swiper", {
  loop: true,
  observer: true,
  observerParents: true,
  slidesPerView: 1,
  spaceBetween: 32,
  speed: 800,
  loop: true,
  loopAdditionalSlides: 5,
  preloadImages: false,
  lazy: true,

  // Navigation arrows
  navigation: {
    nextEl: ".kitchen-large__controls_right",
    prevEl: ".kitchen-large__controls_left",
  },
});
const kitchenLargeSwiper = new Swiper(".kitchen-small__swiper", {
  slidesPerView: 1,
  spaceBetween: 32,
  speed: 800,
  loop: true,
  preloadImages: false,
  lazy: true,

  // Navigation arrows
  navigation: {
    nextEl: ".kitchen-small__controls_right",
    prevEl: ".kitchen-small__controls_left",
  },
});
const kitchenFullSwiper = new Swiper(".kitchen-full__swiper", {
  loop: true,
  slidesPerView: 1,
  spaceBetween: 32,
  speed: 800,
  preloadImages: false,
  lazy: true,

  // Navigation arrows
  navigation: {
    nextEl: ".kitchen-full__controls_right",
    prevEl: ".kitchen-full__controls_left",
  },
});
const gallaryDetailSwiper = new Swiper(".detail-gallary__swiper", {
  loop: true,
  slidesPerView: "auto",
  spaceBetween: 20,
  freeMode: true,
});
const popularKitSwiper = new Swiper(".popular-kit__swiper", {
  slidesPerView: 1,
  spaceBetween: 10,

  breakpoints: {
    375: {
      slidesPerView: 1.3,
      spaceBetween: 10,
    },
    650: {
      slidesPerView: 2,
      spaceBetween: 40,
    },
    1280: {
      slidesPerView: 3,
      spaceBetween: 30,
    },
  },
  navigation: {
    nextEl: ".popular-kit__button_right",
    prevEl: ".popular-kit__button_left",
  },
});
const rewievsCardSwiper = new Swiper(".reviews-card__swiper", {
  slidesPerView: 1,
  spaceBetween: 10,
  speed: 800,
  loop: true,
  lazy: true,
  navigation: {
    nextEl: ".reviews-card__swiper-controls_right",
    prevEl: ".reviews-card__swiper-controls_left",
  },
});

const materialsSwiper = new Swiper(".materials__swiper", {
  slidesPerView: 1,
  spaceBetween: -10,
  parallax: true,
  enabled: false,
  // loop: true,
  speed: 800,
  navigation: {
    nextEl: ".materials__control-button",
  },
  breakpoints: {
    770.5: {
      enabled: true,
    },
  },
});

// ====================== MASONRY ======================

if (document.querySelector(".reviews-list__body")) {
  const masonryReviews = new Masonry(".reviews-list__body", {
    itemSelector: ".masonry-element",
    columnWidth: ".reviews-list__card",
    gutter: ".reviews-list__column-gap",
    percentPosition: true,
  });
}

// ====================== ACCORDIONS ======================

if (document.querySelector(".benefits__body")) {
  const benefitsAccordion = new Accordion(".benefits__body", {
    openOnInit: [0],
    collapse: true,
  });
}
if (document.querySelector(".filter-selector")) {
  const filterAccordion = new Accordion(".filter-selector", {});
}

if (document.querySelector(".stages__accordion")) {
  const stagesAccordions = [...document.querySelectorAll(".stages__accordion")];
  const filterAccordion = new Accordion(stagesAccordions, {});
}

// ====================== HEADER ======================
function header() {
  const header = document.querySelector(".header");
  const menuBtn = document.querySelector(".header__menu-btn");
  let menuIsActive = false;

  function toggleMenu() {
    if (menuIsActive) {
      header.classList.remove("open-menu");
      menuIsActive = false;
    } else {
      header.classList.add("open-menu");
      menuIsActive = true;
    }
  }

  menuBtn.addEventListener("click", toggleMenu);
}

document.addEventListener("DOMContentLoaded", () => {
  header();
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJzY3JpcHQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gPT09PT09PT09PT09PT09PT09PT09PSBMQVpZLUxPQURJTkcgPT09PT09PT09PT09PT09PT09PT09PVxuY2xhc3MgT2JzZXJ2ZXIge1xuICBjb25zdHJ1Y3Rvcih7XG4gICAgZWxlbWVudCxcbiAgICBhY3RpdmF0aW9uUmFuZ2VUb3AsXG4gICAgYWN0aXZhdGlvblJhbmdlQm90dG9tLFxuICAgIHBsYXlPbmNlLFxuICAgIHVwZGF0ZUZyZXF1ZW5jeSxcbiAgICBhY3RpdmVDbGFzcyxcbiAgICB0b3AsXG4gICAgYm90dG9tLFxuICAgIGltYWdlTG9hZCxcbiAgfSkge1xuICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy50b3AgPSBhY3RpdmF0aW9uUmFuZ2VUb3AgPyB0b3AgfHwgMCA6IG51bGw7XG4gICAgdGhpcy5ib3R0b20gPSBhY3RpdmF0aW9uUmFuZ2VCb3R0b20gPyBib3R0b20gfHwgMCA6IG51bGw7XG4gICAgdGhpcy5hY3RpdmF0aW9uUmFuZ2VUb3AgPSBhY3RpdmF0aW9uUmFuZ2VUb3AgfHwgZmFsc2U7XG4gICAgdGhpcy5hY3RpdmF0aW9uUmFuZ2VCb3R0b20gPSBhY3RpdmF0aW9uUmFuZ2VCb3R0b20gfHwgZmFsc2U7XG4gICAgdGhpcy5wbGF5T25jZSA9IHBsYXlPbmNlIHx8IGZhbHNlO1xuICAgIHRoaXMudXBkYXRlRnJlcXVlbmN5ID0gdXBkYXRlRnJlcXVlbmN5IHx8IDIwO1xuICAgIHRoaXMuYWN0aXZlQ2xhc3MgPSBhY3RpdmVDbGFzcyB8fCBcIl9zY3JvbGxcIjtcbiAgICB0aGlzLmltYWdlTG9hZCA9IGltYWdlTG9hZDtcbiAgICAvLyDQktC90YPRgtGA0LXQvdC90LjQtSDQv9C10YDQtdC80LXQvdC90YvQtVxuICAgIHRoaXMuZW50cmllcyA9IG51bGw7XG4gICAgdGhpcy5vYnNlcnZlciA9IG51bGw7XG4gICAgdGhpcy5vYnNlcnZlKCk7XG4gIH1cblxuICBfdGhyZXNob2xkQXJyYXkoKSB7XG4gICAgcmV0dXJuIEFycmF5KHRoaXMudXBkYXRlRnJlcXVlbmN5ICsgMSlcbiAgICAgIC5maWxsKDApXG4gICAgICAubWFwKChpdGVtLCBpbmRleCkgPT4gaW5kZXggLyB0aGlzLnVwZGF0ZUZyZXF1ZW5jeSB8fCAwKTtcbiAgfVxuXG4gIF9oYW5kbGVJbnRlcnNlY3QoZW50cmllcykge1xuICAgIFt0aGlzLmVudHJpZXNdID0gZW50cmllcztcbiAgICB0aGlzLnNjcm9sbEhhbmRsZXIoKTtcbiAgICBpZiAodGhpcy5wbGF5T25jZSkge1xuICAgICAgdGhpcy51bm9ic2VydmUoKTtcbiAgICB9XG4gIH1cblxuICBvYnNlcnZlKCkge1xuICAgIHRoaXMub2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIodGhpcy5faGFuZGxlSW50ZXJzZWN0LmJpbmQodGhpcyksIHtcbiAgICAgIHRocmVzaG9sZDogdGhpcy5fdGhyZXNob2xkQXJyYXkoKSxcbiAgICB9KTtcblxuICAgIHRoaXMub2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsZW1lbnQpO1xuICB9XG5cbiAgdW5vYnNlcnZlKCkge1xuICAgIGNvbnN0IGRlc3Ryb3lXYXRjaGVyID0gKCkgPT4ge1xuICAgICAgdGhpcy5vYnNlcnZlci51bm9ic2VydmUodGhpcy5lbGVtZW50KTtcbiAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwidHJhbnNpdGlvbmVuZFwiLCBkZXN0cm95V2F0Y2hlcik7XG4gICAgfTtcbiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcInRyYW5zaXRpb25lbmRcIiwgZGVzdHJveVdhdGNoZXIpO1xuICB9XG5cbiAgYWRkQ2xhc3MoKSB7XG4gICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUodGhpcy5hY3RpdmVDbGFzcyk7XG4gIH1cblxuICByZW1vdmVDbGFzcygpIHtcbiAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0aGlzLmFjdGl2ZUNsYXNzKTtcbiAgfVxuXG4gIHNjcm9sbEhhbmRsZXIoKSB7XG4gICAgaWYgKHRoaXMuYWN0aXZhdGlvblJhbmdlVG9wIHx8IHRoaXMuYWN0aXZhdGlvblJhbmdlQm90dG9tKSB7XG4gICAgICB0aGlzLmRldGVybWluaW5nRGlyZWN0aW9uKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW5PYmplY3QoKTtcbiAgICB9XG4gIH1cblxuICBkZXRlcm1pbmluZ0RpcmVjdGlvbigpIHtcbiAgICBpZiAodGhpcy5hY3RpdmF0aW9uUmFuZ2VUb3ApIHtcbiAgICAgIHRoaXMuYXREaXN0YW5jZU9uVG9wKCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmFjdGl2YXRpb25SYW5nZUJvdHRvbSkge1xuICAgICAgdGhpcy5hdERpc3RhbmNlT25Cb3R0b20oKTtcbiAgICB9XG4gIH1cblxuICBhdERpc3RhbmNlT25Ub3AoKSB7XG4gICAgcmV0dXJuIHRoaXMuZW50cmllcy5ib3VuZGluZ0NsaWVudFJlY3QudG9wID49IHRoaXMudG9wXG4gICAgICA/IHRoaXMuYWRkQ2xhc3MoKVxuICAgICAgOiB0aGlzLnJlbW92ZUNsYXNzKCk7XG4gIH1cblxuICBhdERpc3RhbmNlT25Cb3R0b20oKSB7XG4gICAgcmV0dXJuIHRoaXMuZW50cmllcy5ib3VuZGluZ0NsaWVudFJlY3QuYm90dG9tIDw9IHRoaXMuYm90dG9tXG4gICAgICA/IHRoaXMuYWRkQ2xhc3MoKVxuICAgICAgOiB0aGlzLnJlbW92ZUNsYXNzKCk7XG4gIH1cbiAgc2V0SW1hZ2VTcmMoKSB7XG4gICAgY29uc3Qgc3JjID0gdGhpcy5lbGVtZW50LmRhdGFzZXQuc3JjO1xuXG4gICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZShcInNyY1wiLCBzcmMpO1xuXG4gICAgdGhpcy5lbGVtZW50Lm9ubG9hZCA9ICgpID0+IHtcbiAgICAgIHRoaXMub2JzZXJ2ZXIudW5vYnNlcnZlKHRoaXMuZWxlbWVudCk7XG4gICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKFwiZGF0YS1zcmNcIik7XG4gICAgICB0aGlzLmVsZW1lbnQuZGF0YXNldC5sYXp5ID0gXCJkb25lXCI7XG4gICAgfTtcblxuICAgIHRoaXMuZWxlbWVudC5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50LmRhdGFzZXQubGF6eSA9IFwiZXJyb3ItbG9hZGluZ1wiO1xuICAgIH07XG4gIH1cbiAgaW5PYmplY3QoKSB7XG4gICAgaWYgKHRoaXMuZW50cmllcy5pc0ludGVyc2VjdGluZykge1xuICAgICAgdGhpcy5hZGRDbGFzcygpO1xuICAgICAgdGhpcy5pbWFnZUxvYWQgPyB0aGlzLnNldEltYWdlU3JjKCkgOiBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZUNsYXNzKCk7XG4gICAgfVxuICB9XG59XG5jb25zdCBsYXp5SW1hZ2VzID0gWy4uLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJpbWdbZGF0YS1sYXp5XVwiKV07XG5pZiAobGF6eUltYWdlcykge1xuICBsYXp5SW1hZ2VzLmZvckVhY2goKGltYWdlKSA9PiB7XG4gICAgY29uc3QgaW1hZ2VPYnNlcnZlID0gbmV3IE9ic2VydmVyKHtcbiAgICAgIGVsZW1lbnQ6IGltYWdlLFxuICAgICAgaW1hZ2VMb2FkOiB0cnVlLFxuICAgIH0pO1xuICB9KTtcbn1cbi8vID09PT09PT09PT09PT09PT09PT09PT0gUE9QVVBTID09PT09PT09PT09PT09PT09PT09PT1cbmNsYXNzIFBvcHVwcyB7XG4gIGNvbnN0cnVjdG9yKHsgcG9wdXAsIG9wZW5CdXR0b25zLCBjbG9zZUJ1dHRvbnMsIGFjdGl2ZUNsYXNzIH0pIHtcbiAgICB0aGlzLnBvcHVwID0gcG9wdXA7XG4gICAgdGhpcy5vcGVuQnV0dG9ucyA9IG9wZW5CdXR0b25zO1xuICAgIHRoaXMuY2xvc2VCdXR0b25zID0gY2xvc2VCdXR0b25zO1xuICAgIHRoaXMuYWN0aXZlQ2xhc3MgPSBhY3RpdmVDbGFzcyB8fCBcIl9hY3RpdmVcIjtcbiAgICBpZiAoIXBvcHVwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuaW5pdCgpO1xuICB9XG4gIGluaXQoKSB7XG4gICAgdGhpcy5jbG9zZUJ1dHRvbnMuZm9yRWFjaCgoYnV0dG9uKSA9PiB7XG4gICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMuY2xvc2UuYmluZCh0aGlzKSk7XG4gICAgfSk7XG4gICAgdGhpcy5vcGVuQnV0dG9ucy5mb3JFYWNoKChidXR0b24pID0+IHtcbiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5vcGVuLmJpbmQodGhpcykpO1xuICAgIH0pO1xuICB9XG5cbiAgb3BlbigpIHtcbiAgICB0aGlzLnBvcHVwLmNsYXNzTGlzdC5hZGQodGhpcy5hY3RpdmVDbGFzcyk7XG4gICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9IFwiaGlkZGVuXCI7XG4gIH1cbiAgY2xvc2UoKSB7XG4gICAgdGhpcy5wb3B1cC5jbGFzc0xpc3QucmVtb3ZlKHRoaXMuYWN0aXZlQ2xhc3MpO1xuICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSBcImluaXRpYWxcIjtcbiAgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09IEZPUk0gPT09PT09PT09PT09PT09PT09PT09PVxuY2xhc3MgRm9ybSB7XG4gIGNvbnN0cnVjdG9yKGZvcm0sIHsgZXJyb3JDbGFzcywgcG9wdXBOZXh0LCBwb3B1cEN1cnJlbnQgfSkge1xuICAgIHRoaXMuZm9ybSA9IGZvcm07XG4gICAgdGhpcy5lcnJvckNsYXNzID0gZXJyb3JDbGFzcztcbiAgICB0aGlzLnBvcHVwTmV4dCA9IHBvcHVwTmV4dDtcbiAgICB0aGlzLnBvcHVwQ3VycmVudCA9IHBvcHVwQ3VycmVudDtcblxuICAgIC8v0LrQvtC90YHRgtCw0L3RgtGLXG4gICAgdGhpcy5zdWJtaXRCdXR0b24gPSBudWxsO1xuICAgIHRoaXMuaW5wdXRzID0gW107XG5cbiAgICAvL9Ci0LXQutGB0YIg0L7RiNC40LHQvtC6INCy0LDQu9C40LTQsNGG0LjQuFxuICAgIHRoaXMud29yZHMgPSB7XG4gICAgICB2YWxpZGF0aW9uTGVuZ2h0OiBcItCd0LXQtNC+0YHRgtCw0YLQvtGH0L3QviDRgdC40LzQstC+0LvQvtCyXCIsXG4gICAgICB2YWxpZGF0aW9uTnVsbDogXCLQrdGC0L4g0L7QsdGP0LfQsNGC0LXQu9GM0L3QvtC1INC/0L7Qu9C1XCIsXG4gICAgICB2YWxpZGF0aW9uRW1haWw6IFwi0J3QtdC/0YDQsNCy0LjQu9GM0L3Ri9C5INGE0L7RgNC80LDRgiBFbWFpbFwiLFxuICAgICAgc3VibWl0RXJyb3I6IFwi0J7RiNC40LHQutCwINC+0YLQv9GA0LDQstC60Lgg0YTQvtGA0LzRi1wiLFxuICAgIH07XG5cbiAgICAvL9CY0L3QuNGG0LjQsNC70LjQt9Cw0YbQuNGPXG4gICAgaWYgKHRoaXMuZm9ybSkge1xuICAgICAgdGhpcy5zZWFyY2hGb3JtRWxlbWVudHMoKTsgLy8g0KHQvtCx0LjRgNCw0LXQvCDQtNCw0L3QvdGL0LUg0YTQvtGA0LzRi1xuICAgICAgdGhpcy5pbnB1dE9ic2VydmUoKTsgLy8g0YHRgtCw0LLQuNC8INC90LAg0L3QuNGFINGB0LvRg9GI0LDRgtC10LvQuFxuICAgICAgdGhpcy5jaGVja0Zvcm1WYWxpZGl0eSgpOyAvLyDRgdGC0LDQstC40Lwg0YHQu9GD0YjQsNGC0LXQu9GMINC90LAg0LrQvdC+0L/QutGDIHN1Ym1pdCDQtNC70Y8g0L/RgNC+0LLQtdGA0LrQuCDRhNC+0YDQvNGLINC90LAg0L/Rg9GB0YLQvtGC0YNcbiAgICAgIHRoaXMuc3VibWl0KCk7IC8vINGB0YLQsNCy0LjQvCBldmVudCBzdWJtaXQg0L3QsCDRhNC+0YDQvNGDINC00LvRjyDQvtGC0L/RgNCw0LLQutC4XG4gICAgfVxuICB9XG4gIC8vINCf0L7QuNGB0Log0L3Rg9C20L3Ri9GFINC/0L7Qu9C10Lkg0YTQvtGA0LzRi1xuICBzZWFyY2hGb3JtRWxlbWVudHMoKSB7XG4gICAgWy4uLnRoaXMuZm9ybS5lbGVtZW50c10uZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgaWYgKGVsZW1lbnQubm9kZU5hbWUgPT09IFwiSU5QVVRcIiB8fCBlbGVtZW50Lm5vZGVOYW1lID09PSBcIlRFWFRBUkVBXCIpIHtcbiAgICAgICAgdGhpcy5pbnB1dHMucHVzaChlbGVtZW50KTtcbiAgICAgIH1cbiAgICAgIGlmIChlbGVtZW50Lm5vZGVOYW1lID09PSBcIkJVVFRPTlwiICYmIGVsZW1lbnQudHlwZSA9PT0gXCJzdWJtaXRcIikge1xuICAgICAgICB0aGlzLnN1Ym1pdEJ1dHRvbiA9IGVsZW1lbnQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLy8g0KPRgdGC0LDQvdC+0LLQutCwINGB0LvRg9GI0LDRgtC10LvRjyDQvdCwINC60LDQttC00YvQuSBpbnB1dFxuICBpbnB1dE9ic2VydmUoKSB7XG4gICAgdGhpcy5pbnB1dHMuZm9yRWFjaCgoaW5wdXQpID0+IHtcbiAgICAgIHRoaXMuc2V0TGlzdGVuZXIoaW5wdXQpO1xuICAgIH0pO1xuICB9XG4gIC8vINCe0YLRh9C40YHRgtC60LAg0L/QvtC70LXQuSDQuNC90L/Rg9GC0L7QslxuICBjbGVhbklucHV0cygpIHtcbiAgICB0aGlzLmlucHV0cy5mb3JFYWNoKChpbnB1dCkgPT4ge1xuICAgICAgaW5wdXQudmFsdWUgPSBcIlwiO1xuICAgIH0pO1xuICB9XG4gIC8v0JLQsNC70LjQtNCw0YbQuNGPINGE0L7RgNC80Ysg0L/RgNC4INC60LvQuNC60LUg0L3QsCDQutC90L7Qv9C60YMgc3VibWl0XG4gIGNoZWNrRm9ybVZhbGlkaXR5KCkge1xuICAgIHRoaXMuc3VibWl0QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICB0aGlzLmlucHV0cy5mb3JFYWNoKChpbnB1dCkgPT4ge1xuICAgICAgICB0aGlzLmNoZWNrSW5wdXRWYWxpZGl0eShpbnB1dCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8v0J7QsdGA0LDQsdC+0YLQutCwINC00LDQvdC90YvRhSDQv9GA0Lgg0LLQstC+0LTQtSDRgdC40LzQstC+0LvQsCDQsiDRgtC10LrRg9GJ0LXQtSDQv9C+0LvQtSBpbnB1dFxuICBmb3JtVGFyZ2V0KGV2ZW50KSB7XG4gICAgY29uc3QgeyB0YXJnZXQgfSA9IGV2ZW50O1xuXG4gICAgLy8g0KHRgtCw0LLQuNGCINC80LDRgdC60YMg0LTQu9GPIHR5cGU9J3RlbCdcbiAgICBpZiAodGFyZ2V0LnR5cGUgPT09IFwidGVsXCIpIHtcbiAgICAgIHRoaXMucGhvbmVNYXNrKHRhcmdldCk7XG4gICAgfVxuICAgIC8vINCS0LDQu9C40LTQuNGA0YPQtdGCINC/0L7Qu9GPXG4gICAgdGhpcy5jaGVja0lucHV0VmFsaWRpdHkodGFyZ2V0KTtcblxuICAgIC8vINCQ0L3QuNC80LDRhtC40Y8gcGxhY2Vob2xkZXJcbiAgICB0YXJnZXQudmFsdWUubGVuZ3RoID4gMFxuICAgICAgPyB0aGlzLmFkZEZpbGxlZENhbHNzKHRhcmdldClcbiAgICAgIDogdGhpcy5yZW1vdmVGaWxsZWRDbGFzcyh0YXJnZXQpO1xuICB9XG5cbiAgLy/QqNCw0LHQu9C+0L0g0L7RiNC40LHQutC4XG4gIGVycm9yVGVtcGxhdGUoZXJyb3IpIHtcbiAgICByZXR1cm4gYCA8c3BhbiBjbGFzcz1cIiR7dGhpcy5lcnJvckNsYXNzfVwiPiR7ZXJyb3J9PC9zcGFuPmA7XG4gIH1cblxuICAvL9CU0L7QsdCw0LLQu9GP0LXQvCDRiNCw0LHQu9C+0L0g0L/QvtGB0LvQtSBpbnB1dCdhXG4gIGlucHV0RXJyb3IoaW5wdXQsIGVycm9yKSB7XG4gICAgaW5wdXQuY2xhc3NMaXN0LmFkZChcIl9lcnJvclwiKTtcbiAgICBpbnB1dC5pbnNlcnRBZGphY2VudEhUTUwoXCJhZnRlcmVuZFwiLCB0aGlzLmVycm9yVGVtcGxhdGUoZXJyb3IpLnRyaW0oKSk7XG4gIH1cbiAgLy/Qo9C00LDQu9GP0LXQvCDRiNCw0LHQu9C+0L0g0L/QvtGB0LvQtSBpbnB1dCdhXG4gIHJlbW92ZUlucHV0RXJyb3IoaW5wdXQpIHtcbiAgICBpbnB1dC5jbGFzc0xpc3QucmVtb3ZlKFwiX2Vycm9yXCIpO1xuICAgIGNvbnN0IG5leHRFbGVtZW50ID0gaW5wdXQubmV4dFNpYmxpbmc7XG4gICAgaWYgKFxuICAgICAgbmV4dEVsZW1lbnQubm9kZVR5cGUgPT0gMSAmJlxuICAgICAgbmV4dEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKHRoaXMuZXJyb3JDbGFzcylcbiAgICApIHtcbiAgICAgIG5leHRFbGVtZW50LnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuICAvL9CS0LDQu9C40LTQsNGG0LjRjyDQuNC90L/Rg9GC0LBcbiAgY2hlY2tJbnB1dFZhbGlkaXR5KGlucHV0KSB7XG4gICAgY29uc3QgeyB2YWxpZGF0aW9uTGVuZ2h0LCB2YWxpZGF0aW9uTnVsbCwgdmFsaWRhdGlvbkVtYWlsIH0gPSB0aGlzLndvcmRzO1xuXG4gICAgdGhpcy5yZW1vdmVJbnB1dEVycm9yKGlucHV0KTsgLy8g0YPQtNCw0LvRj9C8INC/0YDQtdC00YvQtNGD0YnQuNC1INC+0YjQuNCx0LrQuFxuXG4gICAgc3dpdGNoICh0cnVlKSB7XG4gICAgICBjYXNlIGlucHV0LnZhbGlkaXR5LnRvb1Nob3J0OlxuICAgICAgICB0aGlzLmlucHV0RXJyb3IoaW5wdXQsIHZhbGlkYXRpb25MZW5naHQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgaW5wdXQudmFsaWRpdHkudmFsdWVNaXNzaW5nOlxuICAgICAgICB0aGlzLmlucHV0RXJyb3IoaW5wdXQsIHZhbGlkYXRpb25OdWxsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIGlucHV0LnZhbGlkaXR5LnR5cGVNaXNtYXRjaDpcbiAgICAgICAgdGhpcy5pbnB1dEVycm9yKGlucHV0LCB2YWxpZGF0aW9uRW1haWwpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMucmVtb3ZlSW5wdXRFcnJvcihpbnB1dCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICAvLyDQn9GA0LXQu9C+0YPQtNC10YAg0YjQsNCx0LvQvtC9XG4gIHByZWxvYWRlclRlbXBsYXRlKCkge1xuICAgIHJldHVybiBgXG4gICAgICA8ZGl2IGNsYXNzPVwicHJlbG9hZGVyXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJwcmVsb2FkZXJfX2NvbnRhaW5lclwiPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV8xXCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV8yXCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV8zXCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV80XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV81XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV82XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV83XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV84XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV85XCI+PC9zcGFuPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyX19pdGVtIHByZWxvYWRlcl9faXRlbV8xMFwiPjwvc3Bhbj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICBgO1xuICB9XG4gIC8vINCw0LrRgtC40LLQuNGA0L7QstCw0YLRjCDQv9GA0LXQu9C+0YPQtNC10YAgINC60L3QvtC/0LrQuFxuICBydW5QcmVsb2FkZXIoKSB7XG4gICAgdGhpcy5zdWJtaXRCdXR0b24uaW5zZXJ0QWRqYWNlbnRIVE1MKFxuICAgICAgXCJiZWZvcmVlbmRcIixcbiAgICAgIHRoaXMucHJlbG9hZGVyVGVtcGxhdGUoKS50cmltKClcbiAgICApO1xuICB9XG4gIC8vINC+0YHRgtCw0L3QvtCy0LjRgtGMINC/0YDQtdC70L7Rg9C00LXRgCAg0LrQvdC+0L/QutC4XG4gIHN0b3BQcmVsb2FkZXIoKSB7XG4gICAgdGhpcy5zdWJtaXRCdXR0b24ubGFzdENoaWxkLnJlbW92ZSgpO1xuICB9XG4gIC8vINCe0LHRgNCw0LHQvtGC0LrQsCDQvtGC0L/RgNCw0LLQutC4XG4gIHN1Ym1pdCgpIHtcbiAgICBsZXQgaXNTZW5kaW5nID0gZmFsc2U7IC8vINGE0LvQsNCzINC00LvRjyDQuNC30LHQtdC20LDQvdC40Y8g0YHQv9Cw0LzQsCDQutC70LjQutC+0LJcbiAgICB0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcihcInN1Ym1pdFwiLCAoZXZlbnQpID0+IHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAvLyDQv9GA0L7QstC10YDRj9C10Lwg0L3QtSDQt9Cw0LrQvtC90YfQuNC70YHRjyDQu9C4INC10YnQtSDQv9GA0LXQtNGL0LTRg9GJ0LjQuSDQt9Cw0L/RgNC+0YFcbiAgICAgIGlmIChpc1NlbmRpbmcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEodGhpcy5mb3JtKTtcbiAgICAgIGlzU2VuZGluZyA9IHRydWU7IC8vINC30LDQv9GA0LXRidCw0LXQvCDQv9C+0YHQu9C10LTRg9GO0YnQuNC1INC30LDQv9GA0L7RgdGLINC/0L7QutCwINC90LUg0LfQsNCy0LXRgNGI0LjRgtGB0Y8g0YLQtdC60YPRidC40LlcblxuICAgICAgdGhpcy5ydW5QcmVsb2FkZXIoKTsgLy8g0LfQsNC/0YPRgdC60LDQtdC8INC70L7Rg9C00LXRgCDQv9GA0Lgg0L7RgtC/0YDQsNCy0LrQtVxuICAgICAgdGhpcy5zdWJtaXRCdXR0b24uZGF0YXNldC5lcnJvck5hbWUgPSBcIlwiOyAvLyDQvtCx0L3Rg9C70Y/QtdC8INGB0L7QvtCx0YnQtdC90LjQtSDQvtCxINC+0YjQuNCx0LrQtVxuXG4gICAgICB0aGlzLnNlbmRGb3JtKGZvcm1EYXRhKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5mb3JtLmRhdGFzZXQuc3RhdGUgPSBcInN1Y2Nlc3NcIjsgLy8g0KHRgtCw0YLRg9GBINGE0L7RgNC80YtcbiAgICAgICAgICB0aGlzLnBvcHVwQ3VycmVudCA/IHRoaXMucG9wdXBDdXJyZW50LmNsb3NlKCkgOiBudWxsOyAvLyDQt9Cw0LrRgNGL0LLQsNC10Lwg0YLQtdC60YPRidC40Lkg0L/QvtC/0LDQvyDQv9GA0Lgg0YPRgdC/0LXRiNC90L7QuSDQvtGC0L/RgNCw0LLQutC1XG4gICAgICAgICAgdGhpcy5wb3B1cE5leHQgPyB0aGlzLnBvcHVwTmV4dC5vcGVuKCkgOiBudWxsOyAvLyDQvtGC0LrRgNGL0LLQsNC10Lwg0YHQu9C10LTRg9GO0YnQuNC5INC/0L7Qv9Cw0L8o0L3QsNC/0YDQuNC80LXRgCDRgSDRg9GB0L/QtdGI0L3QvtC5INC+0YLQv9GA0LDQstC60L7QuSDRhNC+0YDQvNGLKVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgdGhpcy5mb3JtLmRhdGFzZXQuc3RhdGUgPSBcImVycm9yXCI7IC8vINCh0YLQsNGC0YPRgSDRhNC+0YDQvNGLXG4gICAgICAgICAgdGhpcy5zdWJtaXRCdXR0b24uZGF0YXNldC5lcnJvck5hbWUgPSB0aGlzLndvcmRzLnN1Ym1pdEVycm9yOyAvLyDQstGL0LLQvtC00LjQvCDRgdC+0L7QsdGJ0LXQvdC40LUg0L7QsSDQvtGI0LjQsdC60LUg0L/QvtC0INC60L3QvtC/0LrQvtC5XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIH0pXG4gICAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnN0b3BQcmVsb2FkZXIoKTsgLy8g0L/QviDQt9Cw0LLQtdGA0YjQtdC90LjRjiDQt9Cw0L/RgNC+0YHQsCDQvtGB0YLQsNC90LDQstC70LjQstCw0LXQvCDQu9C+0YPQtNC10YBcbiAgICAgICAgICB0aGlzLmNsZWFuSW5wdXRzKCk7IC8vINC4INC+0YfQuNGJ0LDQtdC8INC40L3Qv9GD0YLRi1xuICAgICAgICAgIGlzU2VuZGluZyA9IGZhbHNlOyAvLyDRgNCw0LfRgNC10YjQsNC10Lwg0L7RgtC/0YDQsNCy0LrRgyDQt9Cw0L/RgNC+0YHQsFxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICAvLyDQntGC0L/RgNCw0LLQutCwINGE0L7RgNC80YtcbiAgc2VuZEZvcm0oZGF0YSkge1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBuYW1lOiB0aGlzLmZvcm0ubmFtZSxcbiAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxuICAgIH0pO1xuICAgIGNvbnN0IHVybCA9IFwiL1wiO1xuICAgIHJldHVybiBmZXRjaCh1cmwsIHtcbiAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICBjcmVkZW50aWFsczogXCJpbmNsdWRlXCIsXG4gICAgICBtb2RlOiBcIm5vLWNvcnNcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJmb3JtL211bHRpcGFydFwiLFxuICAgICAgfSxcbiAgICAgIGJvZHksXG4gICAgfSkudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgcmVzcG9uc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSk7XG4gIH1cbiAgLy8g0JzQsNGB0LrQsCDQvdCwINC/0L7Qu9C1INGC0LXQu9C10YTQvtC90LBcbiAgcGhvbmVNYXNrKGlucHV0KSB7XG4gICAgbGV0IHZhbCA9IGlucHV0LnZhbHVlLnJlcGxhY2UoL1xcRC9nLCBcIlwiKTtcblxuICAgIGlmICh2YWwpIHtcbiAgICAgIGlmICh2YWxbMF0gPT09IFwiN1wiIHx8IHZhbFswXSA9PT0gXCI4XCIpIHtcbiAgICAgICAgdmFsID0gdmFsLnNsaWNlKDEpO1xuICAgICAgfVxuXG4gICAgICB2YWwgPSB2YWwubWF0Y2goLyhcXGR7MCwzfSkoXFxkezAsM30pKFxcZHswLDJ9KShcXGR7MCwyfSkvKTtcbiAgICAgIHZhbCA9XG4gICAgICAgIFwiKzdcIiArXG4gICAgICAgICh2YWxbMl0gPyBcIihcIiArIHZhbFsxXSArIFwiKVwiICsgdmFsWzJdIDogdmFsWzFdID8gdmFsWzFdIDogXCJcIikgK1xuICAgICAgICAodmFsWzNdID8gXCItXCIgKyB2YWxbM10gOiBcIlwiKSArXG4gICAgICAgICh2YWxbNF0gPyBcIi1cIiArIHZhbFs0XSA6IFwiXCIpO1xuICAgIH1cblxuICAgIGlucHV0LnZhbHVlID0gdmFsO1xuICB9XG4gIC8vINCU0L7QsdCw0LLQu9C10L3QuNC1INC60LvQsNGB0YHQsCDQsNC90LjQvNCw0YbQuNC4IHBsYWNlaG9sZGVyJ2FcbiAgYWRkRmlsbGVkQ2Fsc3MoZWxlbWVudCkge1xuICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChcIl9maWxsZWRcIik7XG4gIH1cbiAgLy8g0KPQtNCw0LvQtdC90LjQtSDQutC70LDRgdGB0LAg0LDQvdC40LzQsNGG0LjQuCBwbGFjZWhvbGRlcidhXG4gIHJlbW92ZUZpbGxlZENsYXNzKGVsZW1lbnQpIHtcbiAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoXCJfZmlsbGVkXCIpO1xuICB9XG4gIHNldExpc3RlbmVyKGVsZW1lbnQpIHtcbiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJpbnB1dFwiLCB0aGlzLmZvcm1UYXJnZXQuYmluZCh0aGlzKSk7XG4gIH1cbn1cbmNvbnN0IGNhbGNQb3B1cCA9IG5ldyBQb3B1cHMoe1xuICBwb3B1cDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5jYWxjLXBvcHVwXCIpLFxuICBjbG9zZUJ1dHRvbnM6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuY2FsYy1wb3B1cF9fY2xvc2VcIiksXG4gIG9wZW5CdXR0b25zOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiW2RhdGEtcG9wdXAtb3Blbj0nY2FsYyddXCIpLFxufSk7XG5jb25zdCBjYWxsUG9wdXAgPSBuZXcgUG9wdXBzKHtcbiAgcG9wdXA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuY2FsbC1wb3B1cFwiKSxcbiAgY2xvc2VCdXR0b25zOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmNhbGwtcG9wdXBfX2Nsb3NlXCIpLFxuICBvcGVuQnV0dG9uczogZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIltkYXRhLXBvcHVwLW9wZW49J2NhbGwnXVwiKSxcbn0pO1xuY29uc3QgZG9uZVBvcHVwID0gbmV3IFBvcHVwcyh7XG4gIHBvcHVwOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmRvbmUtcG9wdXBcIiksXG4gIGNsb3NlQnV0dG9uczogZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5kb25lLXBvcHVwX19idXR0b25cIiksXG4gIG9wZW5CdXR0b25zOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiW2RhdGEtcG9wdXAtb3Blbj0nZG9uZSddXCIpLFxufSk7XG5cbmNvbnN0IGFwcGxpY2F0aW9uID0gZG9jdW1lbnQuZm9ybXMuYXBwbGljYXRpb247XG5jb25zdCBhcHBsaWNhdGlvbkZyb20gPSBuZXcgRm9ybShhcHBsaWNhdGlvbiwge1xuICBlcnJvckNsYXNzOiBcImlucHV0X19lcnJvclwiLFxuICBwb3B1cE5leHQ6IGRvbmVQb3B1cCxcbn0pO1xuY29uc3QgZGVzaWduZXIgPSBkb2N1bWVudC5mb3Jtcy5kZXNpZ25lcjtcbmNvbnN0IGRlc2lnbmVyRnJvbSA9IG5ldyBGb3JtKGRlc2lnbmVyLCB7XG4gIGVycm9yQ2xhc3M6IFwiaW5wdXRfX2Vycm9yXCIsXG4gIHBvcHVwTmV4dDogZG9uZVBvcHVwLFxufSk7XG5jb25zdCBjYWxjID0gZG9jdW1lbnQuZm9ybXMuY2FsYztcbmNvbnN0IGNhbGNGcm9tID0gbmV3IEZvcm0oY2FsYywge1xuICBlcnJvckNsYXNzOiBcImlucHV0X19lcnJvclwiLFxuICBwb3B1cEN1cnJlbnQ6IGNhbGNQb3B1cCxcbiAgcG9wdXBOZXh0OiBkb25lUG9wdXAsXG59KTtcbmNvbnN0IGNhbGwgPSBkb2N1bWVudC5mb3Jtcy5jYWxsO1xuY29uc3QgY2FsbEZyb20gPSBuZXcgRm9ybShjYWxsLCB7XG4gIGVycm9yQ2xhc3M6IFwiaW5wdXRfX2Vycm9yXCIsXG4gIHBvcHVwQ3VycmVudDogY2FsbFBvcHVwLFxuICBwb3B1cE5leHQ6IGRvbmVQb3B1cCxcbn0pO1xuLy8gPT09PT09PT09PT09PT09PT09PT09PSBDSVJDTEUgVEVYVCA9PT09PT09PT09PT09PT09PT09PT09XG5cbi8vINGA0LDRgdGB0YLQvtGP0L3QuNC1INC80LXQttC00YMg0YHQu9C+0LLQsNC80LhcbmNvbnN0IHJvdGF0ZUJldHdlZW5Xb3JkcyA9ICh2YWx1ZSkgPT4ge1xuICBjb25zdCB3b3JkcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuY2lyY2xlLXRleHRfX3dvcmRcIik7XG5cbiAgbGV0IGRlZyA9IDA7XG5cbiAgZm9yIChsZXQgd29yZCBvZiB3b3Jkcykge1xuICAgIHdvcmQuc3R5bGUudHJhbnNmb3JtID0gYHJvdGF0ZSgke2RlZ31kZWcpYDtcbiAgICBkZWcgKz0gdmFsdWU7XG4gIH1cbn07XG5cbi8vINGA0LDRgdGB0YLQvtGP0L3QuNC1INC80LXQttC00YMg0LHRg9C60LLQsNC80LhcbmNvbnN0IHJvdGF0ZUJldHdlZW5MZXR0ZXJzID0gKHZhbHVlKSA9PiB7XG4gIGNvbnN0IGxldHRlcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmNpcmNsZS10ZXh0X19sZXR0ZXJcIik7XG5cbiAgbGV0IGRlZyA9IDA7XG5cbiAgZm9yIChsZXQgbGV0dGVyIG9mIGxldHRlcnMpIHtcbiAgICBsZXR0ZXIuc3R5bGUudHJhbnNmb3JtID0gYHJvdGF0ZSgke2RlZ31kZWcpYDtcbiAgICBkZWcgKz0gdmFsdWU7XG4gIH1cbn07XG5cbnJvdGF0ZUJldHdlZW5Xb3JkcygwKTtcbnJvdGF0ZUJldHdlZW5MZXR0ZXJzKDEwLjUpO1xuLy8gPT09PT09PT09PT09PT09PT09PT09PSBTV0lQRVIgPT09PT09PT09PT09PT09PT09PT09PVxuXG5jb25zdCBraXRjaGVuU21hbGxTd2lwZXIgPSBuZXcgU3dpcGVyKFwiLmtpdGNoZW4tbGFyZ2VfX3N3aXBlclwiLCB7XG4gIGxvb3A6IHRydWUsXG4gIG9ic2VydmVyOiB0cnVlLFxuICBvYnNlcnZlclBhcmVudHM6IHRydWUsXG4gIHNsaWRlc1BlclZpZXc6IDEsXG4gIHNwYWNlQmV0d2VlbjogMzIsXG4gIHNwZWVkOiA4MDAsXG4gIGxvb3A6IHRydWUsXG4gIGxvb3BBZGRpdGlvbmFsU2xpZGVzOiA1LFxuICBwcmVsb2FkSW1hZ2VzOiBmYWxzZSxcbiAgbGF6eTogdHJ1ZSxcblxuICAvLyBOYXZpZ2F0aW9uIGFycm93c1xuICBuYXZpZ2F0aW9uOiB7XG4gICAgbmV4dEVsOiBcIi5raXRjaGVuLWxhcmdlX19jb250cm9sc19yaWdodFwiLFxuICAgIHByZXZFbDogXCIua2l0Y2hlbi1sYXJnZV9fY29udHJvbHNfbGVmdFwiLFxuICB9LFxufSk7XG5jb25zdCBraXRjaGVuTGFyZ2VTd2lwZXIgPSBuZXcgU3dpcGVyKFwiLmtpdGNoZW4tc21hbGxfX3N3aXBlclwiLCB7XG4gIHNsaWRlc1BlclZpZXc6IDEsXG4gIHNwYWNlQmV0d2VlbjogMzIsXG4gIHNwZWVkOiA4MDAsXG4gIGxvb3A6IHRydWUsXG4gIHByZWxvYWRJbWFnZXM6IGZhbHNlLFxuICBsYXp5OiB0cnVlLFxuXG4gIC8vIE5hdmlnYXRpb24gYXJyb3dzXG4gIG5hdmlnYXRpb246IHtcbiAgICBuZXh0RWw6IFwiLmtpdGNoZW4tc21hbGxfX2NvbnRyb2xzX3JpZ2h0XCIsXG4gICAgcHJldkVsOiBcIi5raXRjaGVuLXNtYWxsX19jb250cm9sc19sZWZ0XCIsXG4gIH0sXG59KTtcbmNvbnN0IGtpdGNoZW5GdWxsU3dpcGVyID0gbmV3IFN3aXBlcihcIi5raXRjaGVuLWZ1bGxfX3N3aXBlclwiLCB7XG4gIGxvb3A6IHRydWUsXG4gIHNsaWRlc1BlclZpZXc6IDEsXG4gIHNwYWNlQmV0d2VlbjogMzIsXG4gIHNwZWVkOiA4MDAsXG4gIHByZWxvYWRJbWFnZXM6IGZhbHNlLFxuICBsYXp5OiB0cnVlLFxuXG4gIC8vIE5hdmlnYXRpb24gYXJyb3dzXG4gIG5hdmlnYXRpb246IHtcbiAgICBuZXh0RWw6IFwiLmtpdGNoZW4tZnVsbF9fY29udHJvbHNfcmlnaHRcIixcbiAgICBwcmV2RWw6IFwiLmtpdGNoZW4tZnVsbF9fY29udHJvbHNfbGVmdFwiLFxuICB9LFxufSk7XG5jb25zdCBnYWxsYXJ5RGV0YWlsU3dpcGVyID0gbmV3IFN3aXBlcihcIi5kZXRhaWwtZ2FsbGFyeV9fc3dpcGVyXCIsIHtcbiAgbG9vcDogdHJ1ZSxcbiAgc2xpZGVzUGVyVmlldzogXCJhdXRvXCIsXG4gIHNwYWNlQmV0d2VlbjogMjAsXG4gIGZyZWVNb2RlOiB0cnVlLFxufSk7XG5jb25zdCBwb3B1bGFyS2l0U3dpcGVyID0gbmV3IFN3aXBlcihcIi5wb3B1bGFyLWtpdF9fc3dpcGVyXCIsIHtcbiAgc2xpZGVzUGVyVmlldzogMSxcbiAgc3BhY2VCZXR3ZWVuOiAxMCxcblxuICBicmVha3BvaW50czoge1xuICAgIDM3NToge1xuICAgICAgc2xpZGVzUGVyVmlldzogMS4zLFxuICAgICAgc3BhY2VCZXR3ZWVuOiAxMCxcbiAgICB9LFxuICAgIDY1MDoge1xuICAgICAgc2xpZGVzUGVyVmlldzogMixcbiAgICAgIHNwYWNlQmV0d2VlbjogNDAsXG4gICAgfSxcbiAgICAxMjgwOiB7XG4gICAgICBzbGlkZXNQZXJWaWV3OiAzLFxuICAgICAgc3BhY2VCZXR3ZWVuOiAzMCxcbiAgICB9LFxuICB9LFxuICBuYXZpZ2F0aW9uOiB7XG4gICAgbmV4dEVsOiBcIi5wb3B1bGFyLWtpdF9fYnV0dG9uX3JpZ2h0XCIsXG4gICAgcHJldkVsOiBcIi5wb3B1bGFyLWtpdF9fYnV0dG9uX2xlZnRcIixcbiAgfSxcbn0pO1xuY29uc3QgcmV3aWV2c0NhcmRTd2lwZXIgPSBuZXcgU3dpcGVyKFwiLnJldmlld3MtY2FyZF9fc3dpcGVyXCIsIHtcbiAgc2xpZGVzUGVyVmlldzogMSxcbiAgc3BhY2VCZXR3ZWVuOiAxMCxcbiAgc3BlZWQ6IDgwMCxcbiAgbG9vcDogdHJ1ZSxcbiAgbGF6eTogdHJ1ZSxcbiAgbmF2aWdhdGlvbjoge1xuICAgIG5leHRFbDogXCIucmV2aWV3cy1jYXJkX19zd2lwZXItY29udHJvbHNfcmlnaHRcIixcbiAgICBwcmV2RWw6IFwiLnJldmlld3MtY2FyZF9fc3dpcGVyLWNvbnRyb2xzX2xlZnRcIixcbiAgfSxcbn0pO1xuXG5jb25zdCBtYXRlcmlhbHNTd2lwZXIgPSBuZXcgU3dpcGVyKFwiLm1hdGVyaWFsc19fc3dpcGVyXCIsIHtcbiAgc2xpZGVzUGVyVmlldzogMSxcbiAgc3BhY2VCZXR3ZWVuOiAtMTAsXG4gIHBhcmFsbGF4OiB0cnVlLFxuICBlbmFibGVkOiBmYWxzZSxcbiAgLy8gbG9vcDogdHJ1ZSxcbiAgc3BlZWQ6IDgwMCxcbiAgbmF2aWdhdGlvbjoge1xuICAgIG5leHRFbDogXCIubWF0ZXJpYWxzX19jb250cm9sLWJ1dHRvblwiLFxuICB9LFxuICBicmVha3BvaW50czoge1xuICAgIDc3MC41OiB7XG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgIH0sXG4gIH0sXG59KTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PSBNQVNPTlJZID09PT09PT09PT09PT09PT09PT09PT1cblxuaWYgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIucmV2aWV3cy1saXN0X19ib2R5XCIpKSB7XG4gIGNvbnN0IG1hc29ucnlSZXZpZXdzID0gbmV3IE1hc29ucnkoXCIucmV2aWV3cy1saXN0X19ib2R5XCIsIHtcbiAgICBpdGVtU2VsZWN0b3I6IFwiLm1hc29ucnktZWxlbWVudFwiLFxuICAgIGNvbHVtbldpZHRoOiBcIi5yZXZpZXdzLWxpc3RfX2NhcmRcIixcbiAgICBndXR0ZXI6IFwiLnJldmlld3MtbGlzdF9fY29sdW1uLWdhcFwiLFxuICAgIHBlcmNlbnRQb3NpdGlvbjogdHJ1ZSxcbiAgfSk7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT0gQUNDT1JESU9OUyA9PT09PT09PT09PT09PT09PT09PT09XG5cbmlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmJlbmVmaXRzX19ib2R5XCIpKSB7XG4gIGNvbnN0IGJlbmVmaXRzQWNjb3JkaW9uID0gbmV3IEFjY29yZGlvbihcIi5iZW5lZml0c19fYm9keVwiLCB7XG4gICAgb3Blbk9uSW5pdDogWzBdLFxuICAgIGNvbGxhcHNlOiB0cnVlLFxuICB9KTtcbn1cbmlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmZpbHRlci1zZWxlY3RvclwiKSkge1xuICBjb25zdCBmaWx0ZXJBY2NvcmRpb24gPSBuZXcgQWNjb3JkaW9uKFwiLmZpbHRlci1zZWxlY3RvclwiLCB7fSk7XG59XG5cbmlmIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLnN0YWdlc19fYWNjb3JkaW9uXCIpKSB7XG4gIGNvbnN0IHN0YWdlc0FjY29yZGlvbnMgPSBbLi4uZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5zdGFnZXNfX2FjY29yZGlvblwiKV07XG4gIGNvbnN0IGZpbHRlckFjY29yZGlvbiA9IG5ldyBBY2NvcmRpb24oc3RhZ2VzQWNjb3JkaW9ucywge30pO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09IEhFQURFUiA9PT09PT09PT09PT09PT09PT09PT09XG5mdW5jdGlvbiBoZWFkZXIoKSB7XG4gIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuaGVhZGVyXCIpO1xuICBjb25zdCBtZW51QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5oZWFkZXJfX21lbnUtYnRuXCIpO1xuICBsZXQgbWVudUlzQWN0aXZlID0gZmFsc2U7XG5cbiAgZnVuY3Rpb24gdG9nZ2xlTWVudSgpIHtcbiAgICBpZiAobWVudUlzQWN0aXZlKSB7XG4gICAgICBoZWFkZXIuY2xhc3NMaXN0LnJlbW92ZShcIm9wZW4tbWVudVwiKTtcbiAgICAgIG1lbnVJc0FjdGl2ZSA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBoZWFkZXIuY2xhc3NMaXN0LmFkZChcIm9wZW4tbWVudVwiKTtcbiAgICAgIG1lbnVJc0FjdGl2ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgbWVudUJ0bi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdG9nZ2xlTWVudSk7XG59XG5cbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJET01Db250ZW50TG9hZGVkXCIsICgpID0+IHtcbiAgaGVhZGVyKCk7XG59KTtcbiJdLCJmaWxlIjoic2NyaXB0LmpzIn0=
